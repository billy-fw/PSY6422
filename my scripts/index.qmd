---
title: "Final Project"
author: "Billy FW"
format: html
editor: visual
---

### Controversy around xG

### Data

The [raw data set](https://github.com/billy-fw/PSY6422/blob/main/raw%20data/england-premier-league-teams-2018-to-2019-stats.csv) used in this project was downloaded directly from a sample of .csv files offered on [Footystats.org](https://footystats.org/download-stats-csv).

### Aims

The statistic xG was introduced to football analysis a few years back, and its

I wanted to analyse how accurate the measures used to assess xG are.

### Data Preparation

```{r}
#| results: "hide"
#| warning: false
#| message: false

#set working directory
setwd("\\\\STUDATA05.shef.ac.uk/home/pc/pcp25bdf/ManW10/Desktop/PSY6422 Data Analysis and Visualisation (AUTUMN 2025~26)/PSY6422_Football")

#load relevant libaries
library(tidyverse)
library(here)
library(plotly)
```

```{r}
#load and read raw data
df<-read.csv(here("raw data", "england-premier-league-teams-2018-to-2019-stats.csv"))
```

```{r}
#| results: "hide"
#glimpse at the data
head(df)
str(df)
glimpse(df)
```

Glimpse of this dataset highlights a lot of variables that i just do not need.

```{r}
#| results: "hide"
#| warning: false
#| message: false
#select relevant variables
xg_var<-names(df %>% select(starts_with("xg")))
variables_to_select<-c("team_name", "wins", "draws", "losses", "goals_scored", "goals_conceded", "league_position", xg_var)
df_select<-df %>%
  select(variables_to_select)
```

And a final check to make sure there is no missing data

```{r}
sum(is.na(df_select))
```

The goals scored column is a total across the season, so I need to create a column that contains the average goals per match.

```{r}
#| results: "hide"
#| warning: false
#| message: false
#create row for average goal scored per match
df_select<-df_select %>%
  mutate(avg_goals_scored = goals_scored/38)
glimpse(df_select)
#round new column to 2 d.p
df_select<-df_select %>%
  mutate(avg_goals_scored = round(avg_goals_scored, 2))
glimpse(df_select$avg_goals_scored)
#rename columns for clarity
df_select<-df_select %>%
  rename(
    actual_goals = avg_goals_scored,
    expected_goals = xg_for_avg_overall
)
```

Cool, lets have a look!

```{r}
#lets have a look
head(df_select)
```

### Interactive Scatter Plot

```{r}
#| warning: false
#| message: false
#| echo: false 
library(ggplot2)
library(plotly)

#Team colours

team_colors <- c(
  "Arsenal FC" = "#EF0107",
  "Tottenham Hotspur FC" = "#132257",
  "Manchester City FC" = "#6CABDD",
  "Leicester City FC" = "#0053A0",
  "Crystal Palace FC" = "#1B458F",
  "Everton FC" = "#003399",
  "Burnley FC" = "#6C1D45",
  "Southampton FC" = "#D71920",
  "AFC Bournemouth" = "#DA291C",
  "Manchester United FC" = "#DA291C",
  "Liverpool FC" = "#C8102E",
  "Chelsea FC" = "#034694",
  "West Ham United FC" = "#7A263A",
  "Watford FC" = "#FBEE23",
  "Newcastle United FC" = "#241F20",
  "Cardiff City FC" = "#1E63B1",
  "Fulham FC" = "#FFFFFF",
  "Brighton & Hove Albion FC" = "#0057B8",
  "Huddersfield Town FC" = "#0E63AD",
  "Wolverhampton Wanderers FC" = "#FDB913"
)

# --- Base ggplot --------------------------------------------------------------

p <- ggplot(
  df_select,
  aes(
    x = actual_goals,
    y = expected_goals,
    color = as.factor(team_name),
    text = paste(
      "Team:", team_name, "<br>",
      "League Position:", league_position, "<br>",
      "Expected Goals:", expected_goals, "<br>",
      "Actual Goals:", actual_goals
    )
  )
) +
  geom_point() +
  geom_smooth(
    aes(group = 1),
    method = "lm",
    se = FALSE,
    color = "darkgreen",
    linetype = "dashed",
    linewidth = 0.5
  ) +
  scale_color_manual(values = team_colors) +
  labs(
    title = "Expected Goals vs Actual Goals Scored (per match)",
    x = "Actual Goals Scored",
    y = "Expected Goals Scored"
  ) +
  theme_minimal()

# --- Convert to Plotly --------------------------------------------------------

p <- ggplotly(p, tooltip = "text") %>%
  layout(showlegend = FALSE)

# --- Add correlation label ----------------------------------------------------

corr_value <- cor(df_select$actual_goals, df_select$expected_goals)
corr_label <- paste0("r = ", round(corr_value, 3))

p <- p %>% layout(
  annotations = list(
    x = 0.05,
    y = 0.95,
    xref = "paper",
    yref = "paper",
    text = corr_label,
    showarrow = FALSE,
    font = list(size = 14, color = "darkgreen")
  )
)

p

```

This scatter plot shows each premier league team and their respective average xG and actual goals scored per match in the 2018/19 season. The regression line illustrates the high correlation percieved between the two variables.
