---
title: "Footystats data"
author: "bfw"
format: html
editor: visual
---

Load relevant packages and upload data:

```{r}
#| results: "hide"
#| warning: false
#| message: false
#| echo: false
#load relevant packages
library(here)
library(tidyverse)
#upload raw data
data_m<-read.csv(here("raw data", "my_premier_league_data.csv"))
```

### Data Origins

The data used for this project was collected from footystats.org between 01/12/25 and 05/12/25. Part of the data was downloaded directly from a sample of .csv files offered on the website. However, the rest of the data is behind a pay wall and therefore had to be scraped. The scraped data includes variables:

-   Season - the football year/season concerned, ranging from 2016/17 (the introduction of xG) to 2024/25,

-   Club - the name of each 20 teams that was in the premier league that season,

-   Expected Goals (xG) - the avergage xG of each team per match across the season,

-   Actual Goals - the average actual goals scored of each team per match across the season.

The scarped data was used to create a csv file in excel to produce my raw data set.

Here is an example of the data:

```{r}
#| warning: false
#| message: false
#| echo: false 
head(data_m)
```

### Research Questions

The overall aim of this project is to test the accuracy of the statistic xG, and whether this xG has become more accurate over time. To understand this, this project aims to test whether:

1.  There is a strong, significant relationship between xG and actual goals scored
2.  The relationship between xG and actual goals scored becomes stronger over time

### Data Preparation

Given that I created this raw data using scraped data, there was not much data preparation needed.

### Data Analysis

#### Overarching Trend

First, I wanted to check whether there was an overall correlation between variables expected goals and actual goals.

```{r}
#| warning: false
#| message: false
#test correlation
ovr_cor<-cor(data_m$Expected_goals, data_m$Actual_goals)
#round to 3 d.p
ovr_cor_rounded<-round(ovr_cor, 3)
#print result
paste("r=", ovr_cor_rounded)
```

Pearson's correlation coefficient (r) indicates a strong relationship between xG and actual goals.

We can visualize this relationship via a scatter plot:

```{r}
#| warning: false
#| message: false
# Create scatter plot of xG and actual goals across all seasons
plot_1<-ggplot(data = data_m, 
               aes(x = Expected_goals,
                   y = Actual_goals)) +
  geom_point(size = 0.9, #add scatter function
             color = "skyblue",
             alpha = 0.7) +
  geom_smooth(method = "lm", #add regression line
              se = FALSE,
              color = "red") +
  labs(title = "Overall Relationship Between Expected Goals (xG) and Actual Goals Scored ", #add labels
       x = "Expected Goals (xG)",
       y = "Actual Goals"
  ) +
    annotate( #add correlation coefficent
    "text",
    x = max(data_m$Expected_goals) * 0.9, #place text 90% of the length along the x-axis
    y = max(data_m$Actual_goals) * 0.7, #70% across the y axis
    label = paste("r =", ovr_cor_rounded),
    size = 4,
    color = "red"
  ) +
  theme_minimal()
plot_1 
```

This visualization highlights a strong relationship between xG and actual goals scored, therefore answering the first research question.

#### Trends per Season

Next I wanted to check whether the strength of this relationship has changed since the introduction of xG.

Here is a correlation matrix of xG and actual goals, per season:

```{r}
#| warning: false
#| message: false
library(kableExtra)
#check correlations per season and compare to mean
cor_by_season <- data_m %>%
  group_by(Season) %>%
  summarise(r = round(cor(Expected_goals, Actual_goals, method = "pearson"), 3))
cor_by_season_col <- data_m %>% #add color to specific values
  group_by(Season) %>%
  summarise(r = round(cor(Expected_goals, Actual_goals, method = "pearson"), 3)) %>%
  mutate(r = cell_spec(
    r,
    color = ifelse(r < ovr_cor, "red", "green")
  ))
cor_by_season_col %>%
  kable(escape = FALSE, align = "c", caption = "Correlation by Season")
```

This table shows that only season 2020/21 falls below the mean (0.742\<0.825) as is highlighted in red. Whereas each other season remained above the mean and is somewhat consistent in value. This is reinforced through the accompanying line chart, highlighting the consistency in values. Other than season 2020/21, which acts as an outlier:

```{r}
#| warning: false
#| message: false
#| results: false
cor_by_season_out <- cor_by_season %>%
  mutate(is_outlier_season = ifelse(Season == "2020/21", TRUE, FALSE))
line_plot <- ggplot(cor_by_season_out, aes(x = Season, y = r, group = 1)) +
  geom_line(color = "green", size = 1) +
  geom_point(aes(color = is_outlier_season), size = 3) +
  scale_color_manual(values = c("FALSE" = "green", "TRUE" = "red")) +
  labs(
    title = "Strength of xG vs Actual Goals Correlation Over Seasons",
    x = "Season",
    y = "Pearson Correlation",
    color = "Outlier"
  ) +
  theme_minimal() +
  expand_limits(y = 0.5)

# Boxplot
box_plot <- ggplot(cor_by_season_out, aes(y = r)) +
  geom_boxplot(fill = "green", outlier.color = "red", outlier.size = 3) +
  geom_point(data = filter(cor_by_season_out, is_outlier_season), 
             aes(x = 1, y = r), color = "red", size = 3) +
  labs(
    title = "Boxplot",
  ) +
  theme_minimal() +
  expand_limits(y = 0.5)
```

```{r}
#| warning: false
#| message: false
library(patchwork)
# Combine side by side
line_plot + box_plot + plot_layout(ncol = 2, widths = c(2, 1))
```
